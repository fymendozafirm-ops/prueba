<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Vendedor - Prueba</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 600px; margin: 0 auto; background: white; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden;
        }
        .header {
            background: #2c3e50; color: white; padding: 20px; text-align: center; position: relative;
        }
        .logout-btn {
            position: absolute; right: 12px; top: 12px; background: #ff6b6b; color:#fff; border: none; border-radius: 8px;
            padding: 8px 12px; cursor: pointer;
        }
        .debug-info {
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; margin: 20px; font-family: monospace; font-size: 12px;
        }
        .form-section { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        input, textarea, select {
            width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 16px; transition: border-color 0.3s;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px 20px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .loading { opacity: 0.7; pointer-events: none; }
        .status { padding: 10px; margin: 10px 0; border-radius: 6px; text-align: center; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error   { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Formulario de Vendedor</h1>
            <p>Prueba de integraci√≥n ClickUp + Strapi</p>
            <button class="logout-btn" onclick="logout()">üö™ Salir</button>
        </div>

        <div class="debug-info">
            <strong>üîç Informaci√≥n de Debug:</strong><br>
            <div id="debugInfo">
                URL actual: <span id="currentUrl"></span><br>
                Par√°metros URL: <span id="urlParams"></span><br>
                User Agent: <span id="userAgent"></span><br>
                ClickUp Context: <span id="clickupContext">Verificando...</span>
            </div>
        </div>

        <div class="form-section">
            <div id="statusMessage"></div>

            <form id="vendorForm">
                <div class="form-group">
                    <label for="vendorId">üÜî ID de Vendedor:</label>
                    <input type="text" id="vendorId" name="vendorId" placeholder="Se auto-detectar√° desde ClickUp">
                </div>

                <div class="form-group">
                    <label for="name">üë§ Nombre Completo:</label>
                    <input type="text" id="name" name="name" placeholder="Nombre del vendedor">
                </div>

                <div class="form-group">
                    <label for="email">üìß Email:</label>
                    <input type="email" id="email" name="email" placeholder="email@empresa.com">
                </div>

                <div class="form-group">
                    <label for="phone">üìû Tel√©fono:</label>
                    <input type="tel" id="phone" name="phone" placeholder="+52 999 123 4567">
                </div>

                <div class="form-group">
                    <label for="company">üè¢ Empresa:</label>
                    <input type="text" id="company" name="company" placeholder="Nombre de la empresa">
                </div>

                <div class="form-group">
                    <label for="position">üíº Cargo:</label>
                    <select id="position" name="position">
                        <option value="">Seleccionar cargo</option>
                        <option value="vendedor">Vendedor</option>
                        <option value="supervisor">Supervisor de Ventas</option>
                        <option value="manager">Gerente de Ventas</option>
                        <option value="director">Director Comercial</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="notes">üìù Notas:</label>
                    <textarea id="notes" name="notes" rows="4" placeholder="Informaci√≥n adicional..."></textarea>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn-primary" onclick="detectClickUpUser()">üîç Detectar Usuario ClickUp</button>
                    <button type="button" class="btn-secondary" onclick="loadStrapiData()">üì• Cargar datos Strapi</button>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-success">üíæ Guardar</button>
                    <button type="button" class="btn-secondary" onclick="clearForm()">üóëÔ∏è Limpiar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== Manejo de sesi√≥n (LEER localStorage.currentSession) =====
        let sessionUser = null;       // usuario activo
        let currentUserId = null;     // usado por tu l√≥gica simulada

        document.addEventListener('DOMContentLoaded', function () {
            // 1) Verificar sesi√≥n
            try { sessionUser = JSON.parse(localStorage.getItem('currentSession')); } catch { sessionUser = null; }
            if (!sessionUser) {
                alert('‚ö†Ô∏è No hay sesi√≥n activa. Inicia sesi√≥n primero.');
                window.location.href = 'login.html';
                return;
            }

            // 2) Autocompletar nombre y email
            if (sessionUser.name)  document.getElementById('name').value  = sessionUser.name;
            if (sessionUser.email) document.getElementById('email').value = sessionUser.email;

            // 3) Prefijar vendorId (si llega por URL respeta ese; si no, usa clickupUserId o id local)
            const urlParams = new URLSearchParams(window.location.search);
            const fromUrl = urlParams.get('vendorId') || urlParams.get('userId');
            if (fromUrl) {
                document.getElementById('vendorId').value = fromUrl;
                currentUserId = fromUrl;
            } else {
                const guessed = sessionUser.clickupUserId || sessionUser.id || ('user_' + btoa(sessionUser.email).slice(0,8));
                document.getElementById('vendorId').value = guessed;
                currentUserId = guessed;
            }

            // 4) Debug inicial
            initializePage();
            loadDebugInfo();
        });

        function logout() {
            localStorage.removeItem('currentSession');
            alert('üëã Sesi√≥n cerrada.');
            window.location.href = 'login.html';
        }

        // ===== Tu l√≥gica original (debug + simulaciones) =====
        function initializePage() {
            // Si llegara vendorId por URL, ya se trat√≥ en el bloque de sesi√≥n
            // Opcional: auto-cargar si hay vendorId
            const vendorId = document.getElementById('vendorId').value;
            if (vendorId) {
                showStatus('‚úÖ ID de vendedor activo: ' + vendorId, 'success');
                setTimeout(() => loadStrapiData(), 800);
            }
        }

        function loadDebugInfo() {
            document.getElementById('currentUrl').textContent   = window.location.href;
            document.getElementById('urlParams').textContent    = window.location.search || 'ninguno';
            document.getElementById('userAgent').textContent    = navigator.userAgent.substring(0, 50) + '...';
            detectClickUpContext();
        }

        function detectClickUpContext() {
            try {
                const inIframe = window !== window.parent;
                if (inIframe) {
                    document.getElementById('clickupContext').textContent = 'üéØ Ejecut√°ndose en iframe (posible ClickUp)';
                    attemptParentCommunication();
                } else {
                    document.getElementById('clickupContext').textContent = 'üåê Ejecut√°ndose independiente';
                }
            } catch {
                document.getElementById('clickupContext').textContent = '‚ùå Error al detectar contexto';
            }
        }

        function attemptParentCommunication() {
            try {
                window.parent.postMessage({ type: 'REQUEST_USER_ID', source: 'vendor-form' }, '*');
                window.addEventListener('message', function(event) {
                    if (event.data && event.data.type === 'USER_ID_RESPONSE') {
                        currentUserId = event.data.userId;
                        document.getElementById('vendorId').value = currentUserId;
                        showStatus('‚úÖ ID obtenido de ClickUp: ' + currentUserId, 'success');
                    }
                });
            } catch (error) {
                console.log('No se pudo comunicar con parent:', error);
            }
        }

        function detectClickUpUser() {
            showStatus('üîç Intentando detectar usuario de ClickUp...', '');
            setTimeout(() => {
                const simulatedUserId = 'user_' + Math.random().toString(36).substr(2, 9);
                currentUserId = simulatedUserId;
                document.getElementById('vendorId').value = simulatedUserId;
                showStatus('‚úÖ Usuario simulado detectado: ' + simulatedUserId, 'success');
            }, 1200);
        }

        async function loadStrapiData() {
            const vendorId = document.getElementById('vendorId').value;
            if (!vendorId) {
                showStatus('‚ö†Ô∏è Primero necesitas un ID de vendedor', 'error');
                return;
            }
            showStatus('üì• Cargando datos desde Strapi (simulado)...', '');
            setTimeout(() => {
                const simulatedData = {
                    name: document.getElementById('name').value || 'Juan P√©rez Garc√≠a',
                    email: document.getElementById('email').value || 'juan.perez@empresa.com',
                    phone: '+52 999 123 4567',
                    company: 'Empresa Demo SA',
                    position: 'vendedor',
                    notes: 'Vendedor con 5 a√±os de experiencia'
                };
                Object.keys(simulatedData).forEach(k => {
                    const el = document.getElementById(k);
                    if (el) el.value = simulatedData[k];
                });
                showStatus('‚úÖ Datos cargados exitosamente (simulaci√≥n)', 'success');
            }, 1200);
        }

        function clearForm() {
            const keepId = document.getElementById('vendorId').value;
            document.getElementById('vendorForm').reset();
            document.getElementById('vendorId').value = keepId || currentUserId || '';
            showStatus('üóëÔ∏è Formulario limpiado', '');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type || ''}">${message}</div>`;
            if (type) {
                setTimeout(() => { statusDiv.innerHTML = ''; }, 4000);
            }
        }

        // Guardado local del formulario (para pruebas)
        document.getElementById('vendorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            // Enlazar al usuario de la sesi√≥n:
            data.submittedBy = sessionUser?.email || 'anon';
            data.submittedAt = new Date().toISOString();

            const key = 'formSubmissions';
            const prev = JSON.parse(localStorage.getItem(key) || '[]');
            prev.push({ id: Date.now().toString(), ...data });
            localStorage.setItem(key, JSON.stringify(prev));

            console.log('Datos guardados (local):', data);
            showStatus('‚úÖ Datos guardados en localStorage', 'success');
        });
    </script>
</body>
</html>
